import javax.swing.*;
import javax.swing.table.DefaultTableModel;
import java.awt.*;
import java.sql.*;

public class DiscountForm extends JFrame {
    private JTextField discountIdField, amountField, startDateField, endDateField;
    private JButton saveButton, exitButton;
    private JTable discountTable;
    private DefaultTableModel tableModel;

    public DiscountForm() {
        setTitle("Discount Records");
        setSize(800, 500);
        setDefaultCloseOperation(JFrame.EXIT_ON_CLOSE);
        setLocationRelativeTo(null);

        // === Input Panel ===
        JPanel inputPanel = new JPanel(new GridLayout(5, 2));
        discountIdField = new JTextField();
        amountField = new JTextField();
        startDateField = new JTextField();
        endDateField = new JTextField();
        saveButton = new JButton("Save Discount");
        exitButton = new JButton("Exit");

        inputPanel.add(new JLabel("Discount ID:"));
        inputPanel.add(discountIdField);
        inputPanel.add(new JLabel("Amount:"));
        inputPanel.add(amountField);
        inputPanel.add(new JLabel("Start Date (yyyy-mm-dd):"));
        inputPanel.add(startDateField);
        inputPanel.add(new JLabel("End Date (yyyy-mm-dd):"));
        inputPanel.add(endDateField);
        inputPanel.add(saveButton);
        inputPanel.add(exitButton);

        // === Table Panel ===
        String[] columns = {"Discount ID", "Amount", "Start Date", "End Date"};
        tableModel = new DefaultTableModel(columns, 0);
        discountTable = new JTable(tableModel);
        JScrollPane tableScrollPane = new JScrollPane(discountTable);

        // === Layout ===
        setLayout(new BorderLayout());
        add(inputPanel, BorderLayout.WEST);
        add(tableScrollPane, BorderLayout.CENTER);

        // === Actions ===
        saveButton.addActionListener(e -> {
            try {
                int discountId = Integer.parseInt(discountIdField.getText().trim());
                float amount = Float.parseFloat(amountField.getText().trim());
                Date startDate = Date.valueOf(startDateField.getText().trim());
                Date endDate = Date.valueOf(endDateField.getText().trim());

                Discount discount = new Discount(discountId, amount, startDate, endDate);
                boolean success = discount.saveToDatabase();

                if (success) {
                    JOptionPane.showMessageDialog(this, "Discount record saved successfully!", "Success", JOptionPane.INFORMATION_MESSAGE);
                    loadDiscountData(); // Refresh the table
                } else {
                    JOptionPane.showMessageDialog(this, "Error saving discount record.", "Error", JOptionPane.ERROR_MESSAGE);
                }

            } catch (Exception ex) {
                JOptionPane.showMessageDialog(this, "Invalid input: " + ex.getMessage(), "Error", JOptionPane.ERROR_MESSAGE);
            }
        });

        exitButton.addActionListener(e -> System.exit(0));

        // === Load initial data ===
        loadDiscountData();

        setVisible(true);
    }

    private void loadDiscountData() {
        tableModel.setRowCount(0); // Clear table first

        String connectionUrl = "jdbc:sqlserver://localhost:1433;databaseName=Carproject;encrypt=true;trustServerCertificate=true;";
        String user = "SANDII";
        String password = "sandy321";

        try (Connection conn = DriverManager.getConnection(connectionUrl, user, password);
             Statement stmt = conn.createStatement();
             ResultSet rs = stmt.executeQuery("SELECT * FROM DISCOUNT")) {

            while (rs.next()) {
                Object[] row = {
                        rs.getInt("DISCOUNT_ID"),
                        rs.getFloat("AMOUNT"),
                        rs.getDate("START_DATE"),
                        rs.getDate("END_DATE")
                };
                tableModel.addRow(row);
            }

        } catch (SQLException e) {
            e.printStackTrace();
            JOptionPane.showMessageDialog(this, "Failed to load discount records.", "Error", JOptionPane.ERROR_MESSAGE);
        }
    }

    public static void main(String[] args) {
        SwingUtilities.invokeLater(DiscountForm::new);
    }
}
