-- Drop foreign key constraints
IF OBJECT_ID('FK_ACCIDENT_INVOLVED__CAR', 'F') IS NOT NULL
BEGIN
    ALTER TABLE ACCIDENT DROP CONSTRAINT FK_ACCIDENT_INVOLVED__CAR;
END

IF OBJECT_ID('FK_CUSTOMER_PAY_PAYMENT', 'F') IS NOT NULL
BEGIN
    ALTER TABLE CUSTOMER DROP CONSTRAINT FK_CUSTOMER_PAY_PAYMENT;
END

IF OBJECT_ID('FK_CUSTOMER_RECIVE_REPORT', 'F') IS NOT NULL
BEGIN
    ALTER TABLE CUSTOMER DROP CONSTRAINT FK_CUSTOMER_RECIVE_REPORT;
END

IF OBJECT_ID('FK_CUSTOMER_HAVE_CUSTOMER', 'F') IS NOT NULL
BEGIN
    ALTER TABLE CUSTOMER_PHONE DROP CONSTRAINT FK_CUSTOMER_HAVE_CUSTOMER;
END

IF OBJECT_ID('FK_DETERMIN_DETERMINE_PAYMENT', 'F') IS NOT NULL
BEGIN
    ALTER TABLE DETERMINE DROP CONSTRAINT FK_DETERMIN_DETERMINE_PAYMENT;
END

IF OBJECT_ID('FK_DETERMIN_DETERMINE_INVESTIG', 'F') IS NOT NULL
BEGIN
    ALTER TABLE DETERMINE DROP CONSTRAINT FK_DETERMIN_DETERMINE_INVESTIG;
END

IF OBJECT_ID('FK_EMPLOYEE_INHERITAN_INVESTIG', 'F') IS NOT NULL
BEGIN
    ALTER TABLE EMPLOYEE DROP CONSTRAINT FK_EMPLOYEE_INHERITAN_INVESTIG;
END

IF OBJECT_ID('FK_EMPLOYEE_HAS_EMPLOYEE', 'F') IS NOT NULL
BEGIN
    ALTER TABLE EMPLOYEE_PHONE DROP CONSTRAINT FK_EMPLOYEE_HAS_EMPLOYEE;
END

IF OBJECT_ID('FK_GENERATE_GENERATE_REPORT', 'F') IS NOT NULL
BEGIN
    ALTER TABLE GENERATE DROP CONSTRAINT FK_GENERATE_GENERATE_REPORT;
END

IF OBJECT_ID('FK_GENERATE_GENERATE2_INVESTIG', 'F') IS NOT NULL
BEGIN
    ALTER TABLE GENERATE DROP CONSTRAINT FK_GENERATE_GENERATE2_INVESTIG;
END

IF OBJECT_ID('FK_INVESTIG_INVESTIGA_INVESTIG', 'F') IS NOT NULL
BEGIN
    ALTER TABLE INVESTIGATE DROP CONSTRAINT FK_INVESTIG_INVESTIGA_INVESTIG;
END

IF OBJECT_ID('FK_INVESTIG_INVESTIGA_ACCIDENT', 'F') IS NOT NULL
BEGIN
    ALTER TABLE INVESTIGATE DROP CONSTRAINT FK_INVESTIG_INVESTIGA_ACCIDENT;
END

IF OBJECT_ID('FK_OWNS_OWNS_CUSTOMER', 'F') IS NOT NULL
BEGIN
    ALTER TABLE OWNS DROP CONSTRAINT FK_OWNS_OWNS_CUSTOMER;
END

IF OBJECT_ID('FK_OWNS_OWNS2_CAR', 'F') IS NOT NULL
BEGIN
    ALTER TABLE OWNS DROP CONSTRAINT FK_OWNS_OWNS2_CAR;
END

IF OBJECT_ID('FK_PAYMENT_REDUCED_DISCOUNT', 'F') IS NOT NULL
BEGIN
    ALTER TABLE PAYMENT DROP CONSTRAINT FK_PAYMENT_REDUCED_DISCOUNT;
END

-- Drop indexes
IF EXISTS (SELECT 1 FROM sys.indexes WHERE name = 'INVOLVED_IN_FK' AND object_id = OBJECT_ID('ACCIDENT'))
BEGIN
    DROP INDEX INVOLVED_IN_FK ON ACCIDENT;
END

IF EXISTS (SELECT 1 FROM sys.indexes WHERE name = 'ACCIDENT_PK' AND object_id = OBJECT_ID('ACCIDENT'))
BEGIN
    DROP INDEX ACCIDENT_PK ON ACCIDENT;
END

-- Drop tables
IF OBJECT_ID('ACCIDENT', 'U') IS NOT NULL
BEGIN
    DROP TABLE ACCIDENT;
END

IF OBJECT_ID('CAR', 'U') IS NOT NULL
BEGIN
    DROP TABLE CAR;
END

IF OBJECT_ID('CUSTOMER', 'U') IS NOT NULL
BEGIN
    DROP TABLE CUSTOMER;
END

IF OBJECT_ID('CUSTOMER_PHONE', 'U') IS NOT NULL
BEGIN
    DROP TABLE CUSTOMER_PHONE;
END

IF OBJECT_ID('DETERMINE', 'U') IS NOT NULL
BEGIN
    DROP TABLE DETERMINE;
END

IF OBJECT_ID('DISCOUNT', 'U') IS NOT NULL
BEGIN
    DROP TABLE DISCOUNT;
END

IF OBJECT_ID('EMPLOYEE', 'U') IS NOT NULL
BEGIN
    DROP TABLE EMPLOYEE;
END

IF OBJECT_ID('EMPLOYEE_PHONE', 'U') IS NOT NULL
BEGIN
    DROP TABLE EMPLOYEE_PHONE;
END

IF OBJECT_ID('GENERATE', 'U') IS NOT NULL
BEGIN
    DROP TABLE GENERATE;
END

IF OBJECT_ID('INVESTIGATE', 'U') IS NOT NULL
BEGIN
    DROP TABLE INVESTIGATE;
END

IF OBJECT_ID('INVESTIGATOR', 'U') IS NOT NULL
BEGIN
    DROP TABLE INVESTIGATOR;
END

IF OBJECT_ID('OWNS', 'U') IS NOT NULL
BEGIN
    DROP TABLE OWNS;
END

IF OBJECT_ID('PAYMENT', 'U') IS NOT NULL
BEGIN
    DROP TABLE PAYMENT;
END

IF OBJECT_ID('REPORT', 'U') IS NOT NULL
BEGIN
    DROP TABLE REPORT;
END

-- Create tables
CREATE TABLE ACCIDENT (
    ACCIDENT_ID INT NOT NULL,
    LICENCE_PLATE VARCHAR(256),
    CAR_ID VARCHAR(256),
    [DATE] DATE NOT NULL,
    LOCATION VARCHAR(256),
    CONSTRAINT PK_ACCIDENT PRIMARY KEY (ACCIDENT_ID)
);

CREATE TABLE CAR (
    LICENCE_PLATE VARCHAR(256) NOT NULL,
    CAR_ID VARCHAR(256) NOT NULL,
    YEAR INT NOT NULL,
    CAR_MODEL VARCHAR(256) NOT NULL,
    CURRENT_VALUE VARCHAR(256) NOT NULL,
    CONSTRAINT PK_CAR PRIMARY KEY (LICENCE_PLATE, CAR_ID)
);

CREATE TABLE CUSTOMER (
    CUSTOMER_ID INT NOT NULL,
    PAYMENT_ID INT NOT NULL,
    REPORT_ID INT NOT NULL,
    FIRST_NAME VARCHAR(256) NOT NULL,
    LAST_NAME VARCHAR(256) NOT NULL,
    DATE_OF_BIRTH DATE NOT NULL,
    AGE INT,
    STREET_NAME VARCHAR(256) NOT NULL,
    CITY_NAME VARCHAR(256) NOT NULL,
    BUILD_NO INT NOT NULL,
    CONSTRAINT PK_CUSTOMER PRIMARY KEY (CUSTOMER_ID)
);

CREATE TABLE CUSTOMER_PHONE (
    CUSTOMER_ID INT NOT NULL,
    PHONE VARCHAR(256) NOT NULL
);

CREATE TABLE DETERMINE (
    PAYMENT_ID INT NOT NULL,
    INVESTIGATOR_ID VARCHAR(1024) NOT NULL,
    CONSTRAINT PK_DETERMINE PRIMARY KEY (PAYMENT_ID, INVESTIGATOR_ID)
);

CREATE TABLE DISCOUNT (
    DISCOUNT_ID INT NOT NULL,
    AMOUNT FLOAT NOT NULL,
    START_DATE DATE NOT NULL,
    END_DATE DATE NOT NULL,
    CONSTRAINT PK_DISCOUNT PRIMARY KEY (DISCOUNT_ID)
);

CREATE TABLE EMPLOYEE (
    INVESTIGATOR_ID VARCHAR(1024) NOT NULL,
    EMPLOYEE_ID INT NOT NULL,
    ACTIVE_CASES INT NOT NULL,
    BD_DATE DATE NOT NULL,
    EMAIL VARCHAR(256) NOT NULL,
    AGE INT,
    FIRST_NAME VARCHAR(256) NOT NULL,
    LAST_NAME VARCHAR(256) NOT NULL,
    CONSTRAINT PK_EMPLOYEE PRIMARY KEY (INVESTIGATOR_ID, EMPLOYEE_ID)
);

CREATE TABLE EMPLOYEE_PHONE (
    INVESTIGATOR_ID VARCHAR(1024) NOT NULL,
    EMPLOYEE_ID INT NOT NULL,
    PHONE VARCHAR(256) NOT NULL
);

CREATE TABLE GENERATE (
    REPORT_ID INT NOT NULL,
    INVESTIGATOR_ID VARCHAR(1024) NOT NULL,
    CONSTRAINT PK_GENERATE PRIMARY KEY (REPORT_ID, INVESTIGATOR_ID)
);

CREATE TABLE INVESTIGATE (
    INVESTIGATOR_ID VARCHAR(1024) NOT NULL,
    ACCIDENT_ID INT NOT NULL,
    CONSTRAINT PK_INVESTIGATE PRIMARY KEY (INVESTIGATOR_ID, ACCIDENT_ID)
);

CREATE TABLE INVESTIGATOR (
    ACTIVE_CASES INT NOT NULL,
    INVESTIGATOR_ID VARCHAR(1024) NOT NULL,
    CONSTRAINT PK_INVESTIGATOR PRIMARY KEY (INVESTIGATOR_ID)
);

CREATE TABLE OWNS (
    CUSTOMER_ID INT NOT NULL,
    LICENCE_PLATE VARCHAR(256) NOT NULL,
    CAR_ID VARCHAR(256) NOT NULL,
    CONSTRAINT PK_OWNS PRIMARY KEY (CUSTOMER_ID, LICENCE_PLATE, CAR_ID)
);

CREATE TABLE PAYMENT (
    PAYMENT_ID INT NOT NULL,
    DISCOUNT_ID INT NOT NULL,
    PAYMENT_METHOD VARCHAR(256) NOT NULL,
    PAYMENT_DATE DATE NOT NULL,
    CONSTRAINT PK_PAYMENT PRIMARY KEY (PAYMENT_ID)
);

CREATE TABLE REPORT (
    REPORT_ID INT NOT NULL,
    GENERATION_DATE DATE NOT NULL,
    BRIEF VARCHAR(MAX) NOT NULL,
    APPROVAL_DATE DATE NOT NULL,
    CONSTRAINT PK_REPORT PRIMARY KEY (REPORT_ID)
);

-- Create indexes
CREATE UNIQUE INDEX ACCIDENT_PK ON ACCIDENT (ACCIDENT_ID ASC);
CREATE INDEX INVOLVED_IN_FK ON ACCIDENT (LICENCE_PLATE ASC, CAR_ID ASC);

CREATE UNIQUE INDEX CAR_PK ON CAR (LICENCE_PLATE ASC, CAR_ID ASC);

CREATE UNIQUE INDEX CUSTOMER_PK ON CUSTOMER (CUSTOMER_ID ASC);
CREATE INDEX PAY_FK ON CUSTOMER (PAYMENT_ID ASC);
CREATE INDEX RECIVE_FK ON CUSTOMER (REPORT_ID ASC);

CREATE INDEX HAVE_FK ON CUSTOMER_PHONE (CUSTOMER_ID ASC);

CREATE UNIQUE INDEX DETERMINE_PK ON DETERMINE (PAYMENT_ID ASC, INVESTIGATOR_ID ASC);
CREATE INDEX DETERMINE_FK ON DETERMINE (PAYMENT_ID ASC);
CREATE INDEX DETERMINE2_FK ON DETERMINE (INVESTIGATOR_ID ASC);

CREATE UNIQUE INDEX DISCOUNT_PK ON DISCOUNT (DISCOUNT_ID ASC);

CREATE UNIQUE INDEX EMPLOYEE_PK ON EMPLOYEE (INVESTIGATOR_ID ASC, EMPLOYEE_ID ASC);
CREATE INDEX INHERITANCE_1_FK ON EMPLOYEE (INVESTIGATOR_ID ASC);

CREATE INDEX HAS_FK ON EMPLOYEE_PHONE (INVESTIGATOR_ID ASC, EMPLOYEE_ID ASC);

CREATE UNIQUE INDEX GENERATE_PK ON GENERATE (REPORT_ID ASC, INVESTIGATOR_ID ASC);
CREATE INDEX GENERATE_FK ON GENERATE (REPORT_ID ASC);
CREATE INDEX GENERATE2_FK ON GENERATE (INVESTIGATOR_ID ASC);

CREATE UNIQUE INDEX INVESTIGATE_PK ON INVESTIGATE (INVESTIGATOR_ID ASC, ACCIDENT_ID ASC);
CREATE INDEX INVESTIGATE_FK ON INVESTIGATE (INVESTIGATOR_ID ASC);
CREATE INDEX INVESTIGATE2_FK ON INVESTIGATE (ACCIDENT_ID ASC);

CREATE UNIQUE INDEX INVESTIGATOR_PK ON INVESTIGATOR (INVESTIGATOR_ID ASC);

CREATE UNIQUE INDEX OWNS_PK ON OWNS (CUSTOMER_ID ASC, LICENCE_PLATE ASC, CAR_ID ASC);
CREATE INDEX OWNS_FK ON OWNS (CUSTOMER_ID ASC);
CREATE INDEX OWNS2_FK ON OWNS (LICENCE_PLATE ASC, CAR_ID ASC);

CREATE UNIQUE INDEX PAYMENT_PK ON PAYMENT (PAYMENT_ID ASC);
CREATE INDEX REDUCED_FK ON PAYMENT (DISCOUNT_ID ASC);

CREATE UNIQUE INDEX REPORT_PK ON REPORT (REPORT_ID ASC);

-- Add foreign key constraints
ALTER TABLE ACCIDENT ADD CONSTRAINT FK_ACCIDENT_INVOLVED__CAR 
    FOREIGN KEY (LICENCE_PLATE, CAR_ID) REFERENCES CAR (LICENCE_PLATE, CAR_ID);

ALTER TABLE CUSTOMER ADD CONSTRAINT FK_CUSTOMER_PAY_PAYMENT 
    FOREIGN KEY (PAYMENT_ID) REFERENCES PAYMENT (PAYMENT_ID);

ALTER TABLE CUSTOMER ADD CONSTRAINT FK_CUSTOMER_RECIVE_REPORT 
    FOREIGN KEY (REPORT_ID) REFERENCES REPORT (REPORT_ID);

ALTER TABLE CUSTOMER_PHONE ADD CONSTRAINT FK_CUSTOMER_HAVE_CUSTOMER 
    FOREIGN KEY (CUSTOMER_ID) REFERENCES CUSTOMER (CUSTOMER_ID);

ALTER TABLE DETERMINE ADD CONSTRAINT FK_DETERMIN_DETERMINE_PAYMENT 
    FOREIGN KEY (PAYMENT_ID) REFERENCES PAYMENT (PAYMENT_ID);

ALTER TABLE DETERMINE ADD CONSTRAINT FK_DETERMIN_DETERMINE_INVESTIG 
    FOREIGN KEY (INVESTIGATOR_ID) REFERENCES INVESTIGATOR (INVESTIGATOR_ID);

ALTER TABLE EMPLOYEE ADD CONSTRAINT FK_EMPLOYEE_INHERITAN_INVESTIG 
    FOREIGN KEY (INVESTIGATOR_ID) REFERENCES INVESTIGATOR (INVESTIGATOR_ID);

ALTER TABLE EMPLOYEE_PHONE ADD CONSTRAINT FK_EMPLOYEE_HAS_EMPLOYEE 
    FOREIGN KEY (INVESTIGATOR_ID, EMPLOYEE_ID) REFERENCES EMPLOYEE (INVESTIGATOR_ID, EMPLOYEE_ID);

ALTER TABLE GENERATE ADD CONSTRAINT FK_GENERATE_GENERATE_REPORT 
    FOREIGN KEY (REPORT_ID) REFERENCES REPORT (REPORT_ID);

ALTER TABLE GENERATE ADD CONSTRAINT FK_GENERATE_GENERATE2_INVESTIG 
    FOREIGN KEY (INVESTIGATOR_ID) REFERENCES INVESTIGATOR (INVESTIGATOR_ID);

ALTER TABLE INVESTIGATE ADD CONSTRAINT FK_INVESTIG_INVESTIGA_INVESTIG 
    FOREIGN KEY (INVESTIGATOR_ID) REFERENCES INVESTIGATOR (INVESTIGATOR_ID);

ALTER TABLE INVESTIGATE ADD CONSTRAINT FK_INVESTIG_INVESTIGA_ACCIDENT 
    FOREIGN KEY (ACCIDENT_ID) REFERENCES ACCIDENT (ACCIDENT_ID);

ALTER TABLE OWNS ADD CONSTRAINT FK_OWNS_OWNS_CUSTOMER 
    FOREIGN KEY (CUSTOMER_ID) REFERENCES CUSTOMER (CUSTOMER_ID);

ALTER TABLE OWNS ADD CONSTRAINT FK_OWNS_OWNS2_CAR 
    FOREIGN KEY (LICENCE_PLATE, CAR_ID) REFERENCES CAR (LICENCE_PLATE, CAR_ID);

ALTER TABLE PAYMENT ADD CONSTRAINT FK_PAYMENT_REDUCED_DISCOUNT 
    FOREIGN KEY (DISCOUNT_ID) REFERENCES DISCOUNT (DISCOUNT_ID);
